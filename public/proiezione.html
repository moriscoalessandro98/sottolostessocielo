<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Proiezione dei sogni</title>
<style>
html, body {
  margin: 0; padding: 0;
  width: 100%; height: 100%;
  overflow: hidden;
  background: #000;
  font-family: "Georgia", serif;
  color: #fff;
}
canvas { 
  position: fixed; 
  inset: 0; 
  z-index: 0; 
  display:block;
}
</style>
</head>
<body>
<canvas id="sky"></canvas>

<script>
const canvas = document.getElementById("sky");
const ctx = canvas.getContext("2d");
let w, h;
function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
window.addEventListener("resize", resize);
resize();

// ---------- STELLE ---------- //
const STAR_COUNT = 500;
const stars = [];
for(let i=0;i<STAR_COUNT;i++){
  stars.push({
    x: Math.random()*w,
    y: Math.random()*h,
    r: Math.random()*1.2+0.2,
    angle: Math.random()*Math.PI*2,
    speed: Math.random()*0.0005 + 0.0001,
    glow: Math.random()*0.5+0.5
  });
}

// ---------- COMETE ---------- //
const comets = [];
function spawnComet(isSpecial=false) {
  if(comets.length>=3) return;
  if(Math.random()< (isSpecial? 0.3 : 0.005)){
    comets.push({
      x: Math.random()*w,
      y: Math.random()*h*0.5,
      vx: Math.random()*4+2,
      vy: Math.random()*2+1,
      life: 0,
      maxLife: Math.random()*60+60,
      special: isSpecial
    });
  }
}

// ---------- SOGNI ---------- //
let dreams = [];
let activeDreams = [];
let dreamIndex = 0;
let lastDreamId = null;

async function fetchDreams(){
  try{
    const res = await fetch("/api/dreams");
    if(res.ok){
      const data = await res.json();
      dreams = shuffle(data.map(d=>d));
      dreamIndex = 0;
    }
  } catch{}
}

function shuffle(array){
  for(let i=array.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [array[i], array[j]]=[array[j], array[i]];
  }
  return array;
}

class Dream {
  constructor(text, x, y){
    this.text = text;
    this.x = x;
    this.y = y;
    this.baseY = y;
    this.opacity = 0;
    this.timer = 0;
    this.visible = true;
    this.color = "#fff";
    this.fluctuationSpeed = 0.5;
  }
  update(dt){
    this.timer += dt;
    // fade-in
    if(this.timer < 60){ 
      this.opacity += 0.015;
      if(this.opacity>0.9) this.opacity=0.9;
    } 
    // fade-out
    else if(this.timer > 400){ 
      this.opacity -= 0.01;
      if(this.opacity<=0){
        this.opacity=0;
        this.visible=false;
      }
    }
    // oscillazione verticale
    this.y = this.baseY + Math.sin(this.timer * 0.05 * this.fluctuationSpeed) * 5;
  }
  draw(){
    if(this.opacity>0){
      ctx.globalAlpha = this.opacity;
      ctx.font = "22px Georgia";
      ctx.fillStyle = this.color;
      ctx.textAlign = "center";
      ctx.shadowBlur = 8;
      ctx.shadowColor = "#fff";
      ctx.fillText(this.text, this.x, this.y);
      ctx.shadowBlur = 0;
      ctx.globalAlpha = 1;
    }
  }
}

// ---------- POSIZIONE NON SOVRAPPOSITIVA ---------- //
function getNonOverlappingPosition(){
  let x, y, tries=0;
  do{
    x = Math.random()*w*0.8 + w*0.1;
    y = Math.random()*h*0.6 + h*0.2;
    let tooClose = activeDreams.some(d=>Math.hypot(d.x - x, d.y - y)<250);
    if(!tooClose) break;
    tries++;
  } while(tries<20);
  return {x,y};
}

// ---------- LOGICA SOGNI ---------- //
let lastSpawnTime = 0;
function manageDreams(dt){
  lastSpawnTime += dt;
  if(lastSpawnTime > 300 && dreams.length>0){
    let dream;
    let attempts = 0;
    do{
      dream = dreams[dreamIndex % dreams.length];
      dreamIndex++;
      attempts++;
    } while(dream._id === lastDreamId && attempts < dreams.length);

    lastDreamId = dream._id;
    const {x,y} = getNonOverlappingPosition();
    activeDreams.push(new Dream(dream.dream, x, y));
    lastSpawnTime = 0;
  }
  activeDreams.forEach(d=>d.update(dt));
  activeDreams = activeDreams.filter(d=>d.visible);
}

// ---------- COSTELLAZIONI ---------- //
function drawConstellations(){
  for(let i=0;i<stars.length;i++){
    for(let j=i+1;j<stars.length;j++){
      const dx = stars[i].x - stars[j].x;
      const dy = stars[i].y - stars[j].y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if(dist<120){
        ctx.strokeStyle = `rgba(255,255,255,${0.15})`;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(stars[i].x, stars[i].y);
        ctx.lineTo(stars[j].x, stars[j].y);
        ctx.stroke();
      }
    }
  }
}

// ---------- EVENTO SPECIALE ---------- //
let specialTimer = 0;
let constellationTimer = 0;
function manageSpecials(dt){
  specialTimer += dt;
  constellationTimer += dt;

  // Evento ogni 30-60 sec
  if(specialTimer>1800){
    specialTimer = 0;
    // aumenta velocità sogni
    activeDreams.forEach(d=>{
      d.fluctuationSpeed = 2;
      d.color = `hsl(${Math.random()*360}, 80%, 80%)`;
    });
    spawnComet(true);
    setTimeout(()=>{ // ripristina dopo 5 sec
      activeDreams.forEach(d=>{
        d.fluctuationSpeed = 0.5;
        d.color = "#fff";
      });
    },5000);
  }

  // Costellazione unica ogni 5 min
  if(constellationTimer>18000){
    constellationTimer=0;
    // seleziona 5-10 stelle casuali e le illumina più forti per un po'
    const specialStars = [];
    for(let i=0;i<Math.min(10, stars.length);i++){
      const s = stars[Math.floor(Math.random()*stars.length)];
      specialStars.push(s);
    }
    let flashCount = 0;
    const flashInterval = setInterval(()=>{
      flashCount++;
      stars.forEach(s=>s.glow=0.5); // reset glow
      specialStars.forEach(s=>s.glow=1.5);
      if(flashCount>20) clearInterval(flashInterval);
    },100);
  }
}

// ---------- ANIMAZIONE ---------- //
let lastTime = 0;
function animate(time=0){
  const dt = (time - lastTime)/16.666;
  lastTime=time;

  // sfondo sfumato leggero
  const grad = ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,"#000014");
  grad.addColorStop(1,"#0a001a");
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,w,h);

  // stelle
  stars.forEach(s=>{
    s.angle += s.speed*dt;
    const cx = w/2 + Math.cos(s.angle)*(s.x-w/2) - Math.sin(s.angle)*(s.y-h/2);
    const cy = h/2 + Math.sin(s.angle)*(s.x-w/2) + Math.cos(s.angle)*(s.y-h/2);
    ctx.globalAlpha = s.glow;
    ctx.fillStyle="#fff";
    ctx.beginPath();
    ctx.arc(cx,cy,s.r,0,Math.PI*2);
    ctx.fill();
  });
  ctx.globalAlpha=1;

  drawConstellations();

  // comete
  spawnComet();
  comets.forEach((c,i)=>{
    ctx.strokeStyle = c.special ? "rgba(255,255,200,0.9)" : "rgba(255,255,255,0.8)";
    ctx.lineWidth = c.special ? 2 : 1;
    ctx.beginPath();
    ctx.moveTo(c.x,c.y);
    ctx.lineTo(c.x - c.vx*4, c.y - c.vy*4);
    ctx.stroke();
    c.x += c.vx; c.y += c.vy;
    c.life++;
    if(c.life>c.maxLife) comets.splice(i,1);
  });

  // sogni
  manageDreams(dt);
  activeDreams.forEach(d=>d.draw());

  // special events
  manageSpecials(dt);

  requestAnimationFrame(animate);
}

animate();
fetchDreams();
setInterval(fetchDreams,8000);

</script>
</body>
</html>
