<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Proiezione dei sogni</title>
<style>
html, body {
  margin: 0; padding: 0;
  width: 100%; height: 100%;
  overflow: hidden;
  background: #000;
  font-family: "Georgia", serif;
  color: #fff;
}
canvas { 
  position: fixed; 
  inset: 0; 
  z-index: 0; 
  display:block;
}
</style>
</head>
<body>
<canvas id="sky"></canvas>

<script>
const canvas = document.getElementById("sky");
const ctx = canvas.getContext("2d");
let w, h;
function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
window.addEventListener("resize", resize);
resize();

// ---------- STELLE ---------- //
const STAR_COUNT = 500;
const stars = [];
for(let i=0;i<STAR_COUNT;i++){
  stars.push({
    x: Math.random()*w,
    y: Math.random()*h,
    r: Math.random()*1.2+0.2,
    angle: Math.random()*Math.PI*2,
    speed: Math.random()*0.0005 + 0.0001
  });
}

// ---------- COMETE ---------- //
const comets = [];
function spawnComet() {
  if(Math.random()<0.005 && comets.length<3){
    comets.push({
      x: Math.random()*w,
      y: Math.random()*h*0.5,
      vx: Math.random()*4+2,
      vy: Math.random()*2+1,
      life: 0,
      maxLife: Math.random()*60+60
    });
  }
}

// ---------- SOGNI ---------- //
let dreams = [];
let activeDreams = [];

async function fetchDreams(){
  try{
    const res = await fetch("/api/dreams");
    if(res.ok){
      const data = await res.json();
      dreams = shuffle(data.map(d=>d.dream));
    }
  } catch{}
}

function shuffle(array){
  for(let i=array.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [array[i],array[j]]=[array[j],array[i]];
  }
  return array;
}

// ---------- DREAM CLASS ---------- //
class Dream {
  constructor(text, x, y){
    this.text = text;
    this.x = x;
    this.y = y;
    this.opacity = 0;
    this.visible = false;
  }
  fadeIn(){
    this.opacity += 0.01;
    if(this.opacity>0.9) this.opacity=0.9;
  }
  fadeOut(){
    this.opacity -= 0.01;
    if(this.opacity<0) this.opacity=0;
  }
  draw(){
    if(this.opacity>0){
      ctx.globalAlpha = this.opacity;
      ctx.font = "22px Georgia";
      ctx.fillStyle = "#fff";
      ctx.textAlign = "center";
      ctx.fillText(this.text, this.x, this.y);
      ctx.globalAlpha = 1;
    }
  }
}

// ---------- LOGICA SOGNI ---------- //
let dreamTimer = 0;
let sequenceIndex = 0;
function manageDreams(dt){
  dreamTimer += dt;

  // Se non ci sono sogni, non fare nulla
  if(dreams.length===0) return;

  // Gestione sequenziale
  if(dreamTimer>180){ // 180 frame ~3s
    const x1 = Math.random()*w*0.7 + w*0.15;
    const y1 = Math.random()*h*0.5 + h*0.25;
    const d = new Dream(dreams[sequenceIndex % dreams.length], x1, y1);
    activeDreams.push(d);
    sequenceIndex++;

    // seconda frase della coppia 3s dopo
    setTimeout(()=>{
      const x2 = Math.random()*w*0.7 + w*0.15;
      const y2 = Math.random()*h*0.5 + h*0.25;
      const d2 = new Dream(dreams[sequenceIndex % dreams.length], x2, y2);
      activeDreams.push(d2);
      sequenceIndex++;
    },3000);

    dreamTimer = 0;
  }

  // fade in/out
  activeDreams.forEach((d,i)=>{
    if(i<activeDreams.length-2){ // lascia visibili solo ultime due
      d.fadeOut();
    } else {
      d.fadeIn();
    }
  });

  // rimuovi quelli invisibili
  activeDreams = activeDreams.filter(d=>d.opacity>0);
}

// ---------- ANIMAZIONE ---------- //
let lastTime = 0;
function animate(time=0){
  const dt = (time - lastTime)/16.666;
  lastTime=time;

  // cielo e stelle
  ctx.fillStyle = "rgba(0,0,0,0.05)"; // lascia leggero trail
  ctx.fillRect(0,0,w,h);
  stars.forEach(s=>{
    s.angle += s.speed*dt;
    const cx = w/2 + Math.cos(s.angle)*(s.x-w/2) - Math.sin(s.angle)*(s.y-h/2);
    const cy = h/2 + Math.sin(s.angle)*(s.x-w/2) + Math.cos(s.angle)*(s.y-h/2);
    ctx.globalAlpha = 0.6;
    ctx.fillStyle="#fff";
    ctx.beginPath();
    ctx.arc(cx,cy,s.r,0,Math.PI*2);
    ctx.fill();
  });
  ctx.globalAlpha = 1;

  // comete
  spawnComet();
  comets.forEach((c,i)=>{
    ctx.strokeStyle = "rgba(255,255,255,0.8)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(c.x,c.y);
    ctx.lineTo(c.x - c.vx*4, c.y - c.vy*4);
    ctx.stroke();
    c.x += c.vx; c.y += c.vy;
    c.life++;
    if(c.life>c.maxLife) comets.splice(i,1);
  });

  // sogni
  manageDreams(dt);
  activeDreams.forEach(d=>d.draw());

  requestAnimationFrame(animate);
}

animate();
fetchDreams();
setInterval(fetchDreams, 8000);

</script>
</body>
</html>
