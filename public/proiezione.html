<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Proiezione dei sogni</title>
<style>
html, body {
  margin: 0; padding: 0;
  width: 100%; height: 100%;
  overflow: hidden;
  background: #000;
  font-family: "Georgia", serif;
  color: #fff;
}
canvas { 
  position: fixed; 
  inset: 0; 
  z-index: 0; 
  display:block;
}
.dream {
  position: absolute;
  color: #fff;
  font-size: 22px;
  font-weight: 500;
  text-align: center;
  white-space: pre-line;
  pointer-events: none;
  opacity: 0;
  transition: opacity 2s ease-in-out;
}
</style>
</head>
<body>
<canvas id="sky"></canvas>

<script>
const canvas = document.getElementById("sky");
const ctx = canvas.getContext("2d");
let w, h;
function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
window.addEventListener("resize", resize);
resize();

// ---------- STELLE ---------- //
const STAR_COUNT = 500;
const stars = [];
for(let i=0;i<STAR_COUNT;i++){
  stars.push({
    x: Math.random()*w,
    y: Math.random()*h,
    r: Math.random()*1.2+0.2,
    angle: Math.random()*Math.PI*2,
    speed: Math.random()*0.0005 + 0.0001
  });
}

// ---------- COMETE ---------- //
const comets = [];
function spawnComet() {
  if(Math.random()<0.005 && comets.length<3){
    comets.push({
      x: Math.random()*w,
      y: Math.random()*h*0.5,
      vx: Math.random()*4+2,
      vy: Math.random()*2+1,
      life: 0,
      maxLife: Math.random()*60+60
    });
  }
}

// ---------- SOGNI ---------- //
let dreams = [];
let activeDreams = [];
let dreamIndex = 0;

async function fetchDreams(){
  try{
    const res = await fetch("/api/dreams");
    if(res.ok){
      const data = await res.json();
      dreams = data.map(d=>d.dream);
      dreams = shuffle(dreams);
      dreamIndex = 0;
    }
  } catch{}
}

function shuffle(array){
  for(let i=array.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [array[i],array[j]]=[array[j],array[i]];
  }
  return array;
}

// ---------- DREAM CLASS ---------- //
class Dream {
  constructor(text, delay){
    this.text = text;
    this.opacity = 0;
    this.x = Math.random()*w*0.8 + w*0.1;
    this.y = Math.random()*h*0.6 + h*0.2;
    this.delay = delay;
    this.timer = 0;
    this.visible = false;
  }
  update(dt){
    this.timer += dt;
    if(this.timer >= this.delay && !this.visible){
      this.visible = true;
      this.timer = 0;
    }
    if(this.visible){
      this.opacity += 0.01;
      if(this.opacity>0.9) this.opacity=0.9;
    }
  }
  fadeOut(){
    this.opacity -= 0.01;
    if(this.opacity<0) this.opacity=0;
  }
  draw(){
    if(this.opacity>0){
      ctx.globalAlpha = this.opacity;
      ctx.font = "22px Georgia";
      ctx.fillStyle = "#fff";
      ctx.textAlign = "center";
      ctx.fillText(this.text, this.x, this.y);
      ctx.globalAlpha = 1;
    }
  }
}

// ---------- LOGICA SOGNI ---------- //
let timer = 0;
function manageDreams(dt){
  timer += dt;
  if(activeDreams.length<2 && dreams.length>0){
    const delay = activeDreams.length===0 ? 0 : 3; // coppia di frasi con 3s di distanza
    const d = new Dream(dreams[dreamIndex % dreams.length], delay);
    activeDreams.push(d);
    dreamIndex++;
  }

  activeDreams.forEach(d=>d.update(dt));
  // rimuovi quelle completamente scomparse
  if(activeDreams.length>0 && activeDreams[0].opacity>=0.9 && timer>8){
    activeDreams[0].fadeOut();
    if(activeDreams[0].opacity<=0) activeDreams.shift();
    timer=0;
  }
}

// ---------- DISEGNA ---------- //
let lastTime = 0;
function animate(time=0){
  const dt = (time - lastTime)/16.666;
  lastTime=time;

  // cielo e stelle
  ctx.fillStyle = "rgba(0,0,0,0.05)"; // lascia leggero trail
  ctx.fillRect(0,0,w,h);
  stars.forEach(s=>{
    s.angle += s.speed*dt;
    const cx = w/2 + Math.cos(s.angle)*(s.x-w/2) - Math.sin(s.angle)*(s.y-h/2);
    const cy = h/2 + Math.sin(s.angle)*(s.x-w/2) + Math.cos(s.angle)*(s.y-h/2);
    ctx.globalAlpha = 0.6;
    ctx.fillStyle="#fff";
    ctx.beginPath();
    ctx.arc(cx,cy,s.r,0,Math.PI*2);
    ctx.fill();
  });
  ctx.globalAlpha = 1;

  // comete
  spawnComet();
  comets.forEach((c,i)=>{
    ctx.strokeStyle = "rgba(255,255,255,0.8)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(c.x,c.y);
    ctx.lineTo(c.x - c.vx*4, c.y - c.vy*4);
    ctx.stroke();
    c.x += c.vx; c.y += c.vy;
    c.life++;
    if(c.life>c.maxLife) comets.splice(i,1);
  });

  // sogni
  manageDreams(dt);
  activeDreams.forEach(d=>d.draw());

  requestAnimationFrame(animate);
}

animate();
fetchDreams();
setInterval(fetchDreams, 8000);
</script>
</body>
</html>
